(function($) {

/**
 * A manager for student blog links contained in a table with one set of fields
 * defining a student link per row and an HTML link that creates another row
 * of fields for defining a student link.
 *
 * @class StudentLinksManager
 *
 * @param table {String|Node} a reference, either via a CSS selector or a Node
 *                            instance, to a single student-links table
 */
var StudentLinksManager = function(tableID) {
	this._$links = $(tableID);
	this._bindEvents();
};

/**
 * CSS identifiers used for managing student links
 *
 * @property _CSS
 * @type {Object}
 * @private
 * @static
 */
StudentLinksManager._CSS = {
	'addLink':     ".add-link",
	'deleteLinks': ".delete-link",
	'links':       ".link"
};

/**
 * A jQuery-wrapped reference to the table containing all the student links
 *
 * @property _$links
 * @type {Object}
 * @default null
 * @private
 */
StudentLinksManager.prototype._$links = null;

/**
 * Register the event handlers used by the link manager to add links
 *
 * @method _bindEvents
 * @private
 */
StudentLinksManager.prototype._bindEvents = function() {
	this._$links.find(StudentLinksManager._CSS.addLink).click($.proxy(this._addLink, this));
	this._$links.click($.proxy(this._deleteLink, this));
};

/**
 * Creates another set of fields for adding a student link
 *
 * @method _addLink
 * @private
 * @static
 *
 * @param e {Object} an event object generated by clicking the "add link" button
 */
StudentLinksManager.prototype._addLink = function(e) {

	e.preventDefault();

	// Clone the last row of links
	var $newLink = this._$links.find(StudentLinksManager._CSS.links + ":visible:last").clone();
	this._$links.append($newLink);
	$newLink.find("input").val('');

	// Update the new row's input attributes, setting any numerical component of
	// field labels or IDs to the new number of rows in the table
	var newID = this._$links.find(StudentLinksManager._CSS.links).length - 1;
	var updateFields = {
		'label': ['for'],
		'input': ['name', 'id']
	};
	var fieldName, i, $el, attr;
	for (fieldName in updateFields) {
		if (updateFields.hasOwnProperty(fieldName)) {
			$.each($newLink.find(fieldName), function(i, el) {
				for (i=0; i<updateFields[fieldName].length; i++) {
					$el = $(el);
					attr = $el.attr(updateFields[fieldName][i]);
					$el.attr(updateFields[fieldName][i], attr.replace(/\d+$/, newID));
				}
			});
		}
	};
};

/**
 * Delete a single student link, hiding its fields in the table
 *
 * @method _deleteLink
 * @private
 *
 * @param e {Object} an event object generated by clicking the "delete link" link
 */
StudentLinksManager.prototype._deleteLink = function(e) {

	e.preventDefault();

	// If the event is coming from a delete link, clear any inputs in the current
	// row and hide it
	var $target = $(e.target);
	if ($target.is(StudentLinksManager._CSS.deleteLinks)) {
		var $link = $target.parents(StudentLinksManager._CSS.links);
		$link.find("input").val('');
		$link.hide();
	}
};

/**
 * Set up the student-links manager once the page is ready
 */
$(document).ready(function() {
	var manager = new StudentLinksManager("#student-blog-links");
});

})(jQuery);
